{% extends "signoff/base.html" %}

{% block title %}Signoff for {{mstone}} {{locale.code}}{% endblock %}

{% block js_include %}
  <script type="text/javascript" src="/static/jquery.js"></script>
{% endblock %}

{% block javascript %}
$(document).ready(function(){
  {% for note in notes %}
  {% ifnotequal note "error" %}
    setTimeout('$(".{{note}}").fadeOut("slow")', {% ifequal note "info" %}2000{% else %}{% ifequal note "warning" %}6000{% else %}15000{% endifequal %}{% endifequal %});
  {% endifnotequal %}
  {% endfor %}
 });

var user = 0

function handleReload(u) {
  window.status = u
  switch (u) {
    case 0:
      $('.signoff_button').hide()
      $('tr.admin').hide()
      break
    case 1:
      $('.signoff_button').show()
      $('tr.admin').hide()
      break
    case 2:
      $('.signoff_button').show()
      $('tr.admin').show()
      break
  }
  user = u
}

{% endblock %}

{% block style %}

html, body {
  background-color: #eee;
  font-size: 14px;
  padding: 0;
  margin: 0;
  font-family: Helvetica, Arial, sans-serfif;
}

.nav {
  background-color: #eef;
  padding: 10px;
  border-bottom: 1px solid #aac;
}

.nav a {
  color: #229;
  margin-left: 15px;
  text-decoration: none;
}

.nav a:hover {
  text-decoration: underline;
}

h3 {
  font-size: 18px;
  margin-left: 10px;
  color: #224;
}

#pushes {
  width: 100%;
  border-top: 1px solid #bbd;
  border-bottom: 1px solid #bbd;
  background-color: #eef;
}

#pushes tr {
  margin: 0;
}

#pushes tr > td {
  border: 1px dotted #bbd;
  padding: 4px;
  width: 10%;
  margin: 0;
  font-size: 13px;
}

#pushes tr.signoff td {
  text-align: center;
}

fieldset.note {
  padding: 5px;
  margin: 10px 0;
}

fieldset.note legend {
  font-weight: bold;
  padding: 2px 5px 0px;
}

fieldset.info {
  background-color: #99ff99;
  border: 1px solid #55aa55;
}

fieldset.info legend {
  background-color: #99ff99;
  border-top: 1px solid #55aa55;
  border-left: 1px solid #88cc88;
  border-right: 1px solid #88cc88;
}

fieldset.warning {
  background-color: #ffff99;
  border: 1px solid #dddd00;
}

fieldset.warning legend {
  background-color: #ffff99;
  border-top: 1px solid #dddd00;
  border-left: 1px solid #ffff00;
  border-right: 1px solid #ffff00;
}

fieldset.error {
  color: white;
  background-color: #bb0000;
  border: 1px solid #550000;
}

fieldset.error legend {
  color: white;
  background-color: #bb0000;
  border-top: 1px solid #990000;
  border-left: 1px solid #990000;
  border-right: 1px solid #990000;
}

.legend {
  display: none;
}

.legend ul {
  list-style-type: none;
}

.legend ul li {
  float: left;
  wrap: no-wrap;
  border: 1px solid black;
}

.legend .box {
  width: 80px;
  height: 20px;
}

#pushes td.push-{{ current.push.id }} {
  border: 1px solid #9a9;
  background-color: #efe;
{% ifequal curcol 1 %}
  background-color: #99ff99;
{% endifequal %}

{% ifequal curcol -1 %}
  background-color: #ff0000;
{% endifequal %}
}

{% if accepted %}
{% ifnotequal accepted.push.id current.push.id %}
#pushes td.push-{{ accepted.push.id }} {
  border: 1px solid #aac;
  background-color: #dde;
}
{% endifnotequal %}
{% endif %}
{% endblock %}

{% block content %}
<div class="nav">
  <a href="{% url signoff.views.locale_list ms=mstone.code %}">« all <i>{{mstone.name}}</i> locales</a>
  <a href="{% url signoff.views.milestone_list loc=locale.code %}">« all <i>{{locale.code}}</i> milestones</a>
</div>
<h3>Signoff for {{mstone}} {{locale.code}}</h3>
<form action="" method="post" id="form_accept">
  <input type="hidden" id="id_accepted" name="accepted" />
</form>
<form action="" method="post" id="form_signoff">
  <input type="hidden" id="id_push" name="push" />
</form>

<table id="pushes">
  <tr>
    {% for push in pushes %}
      {% if push.date %}
      <td {% if push.colspan %}colspan="{{ push.colspan }}"{% endif %}>{{ push.date }}</td>
      {% endif %}
    {% endfor %}
  </tr>
  <tr>
    {% for push in pushes %}
      <td class="push-{{ push.object.id }}">{{ push.time }}</td>
    {% endfor %}
  </tr>
  <tr>
    {% for push in pushes %}
      <td class="push-{{ push.object.id }}">{{ push.object.user }}</td>
    {% endfor %}
  </tr>
  <tr>
    {% for push in pushes %}
      <td class="push-{{ push.object.id }}">{{ push.build }}</td>
    {% endfor %}
  </tr>
  <tr>
    {% for push in pushes %}
      <td class="push-{{ push.object.id }}">{{ push.compare }}</td>
    {% endfor %}
  </tr>
  <tr class="signoff">
    {% for push in pushes %}
      {% if push.current %}
      <td class="push-{{ push.object.id }}">{{ current.when }} {{ current.author }}</td>
      {% else %}
      <td class="push-{{ push.object.id }}"><input type="button" value="Sign off" class="signoff_button" onclick="$('#id_push').val({{ push.object.id }});$('#form_signoff').submit()"/>&nbsp;</td>
      {% endif %}
    {% endfor %}
  </tr>
  <tr class="signoff admin">
    {% for push in pushes %}
      {% if  push.accepted %}
      <td class="push-{{ push.object.id }}">
        accepted
        <br/>
        <input type="button" value="Revoke" onclick="$('#id_accepted').val('False');$('#form_accept').submit()"/>
      </td>
      {% else %}
        {% if push.current %}
        <td class="push-{{ push.object.id }}">
          <input type="button" value="Accept" onclick="$('#id_accepted').val('True');$('#form_accept').submit()"/>
          {% ifnotequal curcol -1 %}
          <input type="button" value="Refuse" onclick="$('#id_accepted').val('False');$('#form_accept').submit()"/>
          {% endifnotequal %}
          {% if accepted %}
          {% ifnotequal accepted.push.id current.push.id %}
          <br/><a href="">diff to previously accepted</a>
          {% endifnotequal %}
          {% endif %}
        </td>
        {% else %}
        <td class="push-{{ push.object.id }}">&nbsp;</td>
        {% endif %}
      {% endif %}
    {% endfor %}
  </tr>
</table>
<fieldset class="legend">
  <legend>Legend</legend>
  <ul>
  	<li><div class="box signedoff" /> - signed off</li>
  	<li><div class="box paccepted" /> - previously accepted</li>
  	<li><div class="box accepted" /> - accepted</li>
  	<li><div class="box refused" /> - refused</li>
  </ul>
</fieldset>
{% for id, note in notes.items %}
  <fieldset class="note {{ id }}">
    <legend>{{ id }}!</legend>
  {{ note|safe }}
  </fieldset>
{% endfor %}

{% endblock %}