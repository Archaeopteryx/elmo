{% extends "signoff/base.html" %}

{% block title %}Signoff for {{mstone}} {{locale.code}}{% endblock %}

{% block js_include %}
  <script type="text/javascript" src="/static/jquery.js"></script>
  <script type="text/javascript" src="/static/ajaxarray.js"></script>
  <script type="text/javascript" src="/static/vptable.js"></script>
  <script type="text/javascript" src="/static/slider.js"></script>
{% endblock %}

{% block javascript %}

var pushes = Array()
var current = {{ current_js|safe}}
var slider = null

$(document).ready(function(){
  slider = Slider()
  slider.setUp($('.slider').get()[0], {{max_pushes}}, {{offset}}, sliderMove)

  var items = Array();

  pushes = jQuery.AjaxArray({
    'json_url': '/signoff/api/pushes?locale={{locale.code}}&mstone={{mstone.code}}&from=$1&to=$2',
    'length': 50,
  }, items)
  
  $('#pushes').vptable({'items':pushes})
  $('#pushes').vptDraw()

  {% for note in notes %}
  {% ifnotequal note "error" %}
    setTimeout('$(".{{note}}").fadeOut("slow")', {% ifequal note "info" %}2000{% else %}{% ifequal note "warning" %}6000{% else %}15000{% endifequal %}{% endifequal %});
  {% endifnotequal %}
  {% endfor %}
 });



function sliderMove(cb) {
  var start = slider.status().start
  var offset = slider.status().offset 
  if (start+offset>pushes.length) {
    getPushes(false, start+offset-1,10, [fillPushes,cb])
    return false
  } else {
    fillPushes()
    return true
  }
}

function stylePushes() {
  var v=30/10
  $('#pushes tr').each(function(i){
    $('td', this).each(function(j){
      with($(this)) {
        css('background-color','rgb('+(225+parseInt(j*v))+','+(225+parseInt(j*v))+',255)')
        if (i==2) // signoff row
          $('a',this).css('color','rgb('+parseInt(34+j*v*2)+','+parseInt(34+j*v*2)+','+parseInt(153+j*v*2)+')')
        css('color','rgb('+parseInt(j*v*4)+','+parseInt(j*v*4)+','+parseInt(j*v*4)+')')
      }
    })
  })
}

function fillPushes(start, offset, N) {
  if (start===N)
    start = slider.status().start
  if (offset===N)
    offset = slider.status().offset
  window.status = start + " - " + offset + " = " + (start+offset) + " | " + pushes.length
  var trs = []
  var obj = $("#pushes").get()
  var prev_date = null
  pushes.get(0,10)
  return
  for(var i in pushes) {
    var push = pushes[i]
    if (i<start) {
      if (push['class'])
        $('.'+push['class']).hide()
      continue
    }else if (i>=offset+start) {
      if (push['class'])
        $('.'+push['class']).hide()
      continue
    } else if (push['class']) {
      $('.'+push['class']).show()
      var td = $('.date > .push-'+push.id, obj)
      if (!prev_date || prev_date != push['date']) {
        if (td.hasClass('empty'))
          td.removeClass('empty').text(push['date'])
        prev_date = push['date']
      } else {
        if (!td.hasClass('empty'))
          td.addClass('empty').html('&nbsp;')
      }
      continue
    } else {
    for (var attr in push) {
      if (!trs[attr])
        trs[attr] = $('tr.'+attr, obj).get()[0]
      if (!trs[attr])
        continue
      if (trs[attr]) {
        var td = document.createElement('td')
        if (trs[attr]) {
          var t = $(td).addClass('push-'+push.id)
          switch (attr) {
            case 'date':
              if (!prev_date || prev_date != push['date']) {
                t.text(push[attr])
                prev_date = push['date']
              } else {
                t.html('&nbsp;')
                t.addClass('empty')
              }
              break
            case 'signoff':
              if (push['signoff']) {
                t.text(current['when']+' '+current['author'])
              } else {
                t.html('<input type="button" value="Sign off" class="signoff_button" onclick="$(\'#id_push\').val('+push['id']+');$(\'#form_signoff\').submit()"/>')
              }
              break
            case 'revision':
              t.html('<a href="'+(push['url'])+'" title="'+(push['revdesc'])+'">'+(push[attr])+'</a>')
              break
            case 'accepted':
              if (push['signoff']) {
                switch (current.accepted) {
                  case null:
                    t.html('<input type="button" value="Accept" onclick="$(\'#id_accepted\').val(\'True\');$(\'#form_accept\').submit()"/><input type="button" value="Refuse" onclick="$(\'#id_accepted\').val(\'False\');$(\'#form_accept\').submit()"/>')
                    break
                  case false:
                    t.html('<input type="button" value="Accept" onclick="$(\'#id_accepted\').val(\'True\');$(\'#form_accept\').submit()"/>')
                    break
                  case true:
                    t.html('<input type="button" value="Revoke" onclick="$(\'#id_accepted\').val(\'False\');$(\'#form_accept\').submit()"/>')
                    break
                }
              } else {
                t.html('&nbsp;')
              }
              break
            default:
              if (push[attr])
                t.text(push[attr])
          }
          insertTdPos(trs[attr], t, i, attr)
          //t.appendTo(trs[attr])
          if (!push['tds'])
            push['tds'] = Array()
          push['tds'][attr] = t
        }
      }
      push['class'] = 'push-'+push.id
      }
    }
  }
  //stylePushes()
}

function insertTdPos(node, elem, pos, attr) {
  for (var i in pushes) {
    var push = pushes[i]
    if (push['class'] && i>pos) {
      elem.insertBefore(push['tds'][attr])
      return true
    }
  }
  elem.appendTo(node)
}

var user = 0

function handleReload(u) {
  switch (u) {
    case 0:
      $('.signoff_button').hide()
      $('tr.admin').hide()
      break
    case 1:
      $('.signoff_button').show()
      $('tr.admin').hide()
      break
    case 2:
      $('.signoff_button').show()
      $('tr.admin').show()
      break
  }
  user = u
}
{% endblock %}

{% block style %}

.pushes {
  width: 100%;
  height: 240px;
  border: 1px solid #bbd;
  border-collapse: collapse;
}

.pushes tr {
  margin: 0;
}

.pushes tr > td {
  border: 1px dotted #bbd;
  padding: 4px;
  width: 10%;
  height: 30px;
  margin: 0;
  font-size: 13px;
}

.pushes td.date {
  border-right: 0 !important;
}

.pushes td.empty {
  border: 0 !important;
}

.pushes tr.signoff td,
.pushes tr.accepted td {
  text-align: center;
}

.legend {
  display: inline;
  margin-top: 20px;
  margin-left: 10px;
}

.legend ul {
  list-style-type: none;
  margin: 0;
  padding:0;
}

.legend ul li {
  float: left;
  margin-left: 10px;
}

.legend .box {
  width: 20px;
  height: 10px;
  display: inline-block;
  border: 1px solid black;
}

.slider {
  float: right;
  margin-top: 10px;
  margin-right: 10px;
}

.slider .prev,
.slider .next,
.slider .slide {
  display: inline-block;
}

.slider .slide {
  width: 100px;
  height: 15px;
  background-color: #d59;
  overflow: hidden;
}

.slider .slide .marker {
  width: 0px;
  height: 15px;
  background-color: green;
}

.search {
  float: right;
}

.legend .box.accepted {background-color:#efe;}
.legend .box.refused {background-color:#ff0000;}
.legend .box.signedoff {background-color:#99ff99;}
.legend .box.paccepted {background-color: #dde;}


#pushes td.push-{{ current.push.id }}:not(.date) {
  border: 1px solid #9a9 !important;
  background-color: #efe !important;
  color: black !important;
{% ifequal curcol 1 %}
  background-color: #99ff99 !important;
{% endifequal %}

{% ifequal curcol -1 %}
  background-color: #ff0000 !important;
{% endifequal %}
}

{% if accepted %}
{% ifnotequal accepted.push.id current.push.id %}
#pushes td.push-{{ accepted.push.id }}:not(.date) {
  border: 1px solid #aac !important;
  background-color: #dde !important;
  color: black !important;
}
{% endifnotequal %}
{% endif %}
{% endblock %}

{% block content %}
<div class="nav">
  <a href="{% url signoff.views.dashboard %}?ms={{mstone.code}}">Â« all <i>{{mstone.name}}</i> locales</a>
</div>
<p class="search">Search: <input type="text" size="10" id="search"></p>
<h3>Signoff for {{mstone}} {{locale.code}}</h3>
<form action="" method="post" id="form_accept">
  <input type="hidden" id="id_comment" name="comment" />
  <input type="hidden" id="id_accepted" name="accepted" />
</form>
<form action="" method="post" id="form_signoff">
  <input type="hidden" id="id_push" name="push" />
</form>

<table id="pushes" class="pushes">
  <tr class="date"></tr>
  <tr class="time"></tr>
  <tr class="revision"></tr>
  <tr class="user"></tr>
  <tr class="build"></tr>
  <tr class="compare"></tr>
  <tr class="signoff"></tr>
  <tr class="accepted"></tr>
</table>
<fieldset class="legend">
  <legend>Legend</legend>
  <ul>
  	<li><div class="box accepted"></div> - accepted</li>
  	<li><div class="box paccepted"></div> - previously accepted</li>
  	<li><div class="box refused"></div> - refused</li>
  	<li><div class="box signedoff"></div> - signed off</li>
  </ul>
</fieldset>
<div class="slider">
  <button class="prev">prev</button>
  <div class="slide">
    <div class="marker"></div>
  </div>
  <button class="next">next</button>
</div>
{% for id, note in notes.items %}
  <fieldset class="note {{ id }}">
    <legend>{{ id }}!</legend>
  {{ note|safe }}
  </fieldset>
{% endfor %}

{% endblock %}