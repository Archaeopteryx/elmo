{% extends "signoff/base.html" %}

{% block title %}Signoff for {{mstone}} {{locale.code}}{% endblock %}

{% block js_include %}
  <script type="text/javascript" src="/static/jquery.js"></script>
  <script type="text/javascript" src="/static/ajaxarray.js"></script>
  <script type="text/javascript" src="/static/vptable.js"></script>
  <script type="text/javascript" src="/static/slider.js"></script>
{% endblock %}

{% block javascript %}

var pushes = Array()
var current = {{ current_js|safe}}
var slider = null
var curpos = null

$(document).ready(function(){
  slider = Slider()
  slider.setUp($('.slider').get()[0], {{max_pushes}}, {{offset}}, sliderMove)

  var items = {{pushes.0|safe}};

  pushes = jQuery.AjaxArray({
    'json_url': '/signoff/api/pushes?locale={{locale.code}}&mstone={{mstone.code}}&from=$1&to=$2',
    'length': {{max_pushes}},
  }, [items,{{pushes.1}},{{pushes.2}}])
  
  vpt = jQuery.vpTable($('#pushes').get(), {'items':pushes})
  vpt.draw({{offset}}, customizeRow)

  {% for note in notes %}
  {% ifnotequal note "error" %}
    setTimeout('$(".{{note}}").fadeOut("slow")', {% ifequal note "info" %}2000{% else %}{% ifequal note "warning" %}6000{% else %}15000{% endifequal %}{% endifequal %});
  {% endifnotequal %}
  {% endfor %}
 });

function sliderMove(cb) {
  var start = slider.status().start+slider.status().v
  vpt.draw(start, customizeRow, cb)
  return false
}

function stylePushes() {
  var v=30/{{max_pushes}}
  var o=slider.status().start+slider.status().v
  if (curpos===null)
    curpos = pushes.get_current()
  $('#pushes tr').each(function(i){
    $('td', this).each(function(j){
      j+=o
      with($(this)) {
        if (j==curpos) {
          addClass('current')
        } else
          removeClass('current')
        css('background-color','rgb('+(225+parseInt(j*v))+','+(225+parseInt(j*v))+',255)')
        if (i==2) // signoff row
          $('a',this).css('color','rgb('+parseInt(34+j*v*2)+','+parseInt(34+j*v*2)+','+parseInt(153+j*v*2)+')')
        css('color','rgb('+parseInt(j*v*4)+','+parseInt(j*v*4)+','+parseInt(j*v*4)+')')
      }
    })
  })
}

var user = 0

function handleReload(u) {
  switch (u) {
    case 0:
      $('.signoff_button').hide()
      $('tr.admin').hide()
      break
    case 1:
      $('.signoff_button').show()
      $('tr.admin').hide()
      break
    case 2:
      $('.signoff_button').show()
      $('tr.admin').show()
      break
  }
  user = u
}


function customizeRow(table, attr, t, push) {
  var prev_date = table.attr('prev_date')||null

  switch (attr) {
    case 'date':
      if (!prev_date || prev_date != push['date']) {
        t.text(push[attr])
        table.attr('prev_date', push['date'])
      } else {
        t.html('&nbsp;').addClass('empty')
      }
      break
    case 'signoff':
      if (push['signoff']) {
        t.text(current['when']+' '+current['author'])
      } else {
        t.html('<input type="button" value="Sign off" class="signoff_button" onclick="onSignoff('+push['id']+')"/>')
      }
      break
    case 'revision':
      t.html('<a href="'+(push['url'])+'" title="'+(push['revdesc'])+'">'+(push[attr])+'</a>')
      break
    case 'accepted':
      if (push['signoff']) {
        switch (current.status) {
          case null:
            t.html('<input type="button" value="Accept" onclick="onAccept(true)"/><input type="button" value="Refuse" onclick="onAccept(false)"/>')
            break
          case false:
            t.html('<input type="button" value="Accept" onclick="onAccept(true)"/>')
            break
          case true:
            t.html('<input type="button" value="Revoke" onclick="onAccept(false)"/>')
            break
        }
      } else {
        t.html('&nbsp;')
      }
      break
    default:
      if (push[attr])
        t.text(push[attr])
  }
  return t
}

function getFirstRevision() {
  return $('#pushes tr.revision > td:first > a').text() 
}

function onAccept(status) {
  $('#id_accepted').val(status)
  $('#id_first_row2').val(getFirstRevision())
  $('#form_accept').submit()
}

function onSignoff(id) {
  $('#id_push').val(id)
  $('#id_first_row').val(getFirstRevision())
  $('#form_signoff').submit()
}
{% endblock %}

{% block style %}

.pushes {
  width: 100%;
  height: 240px;
  border: 1px solid #bbd;
  border-collapse: collapse;
}

.pushes tr {
  margin: 0;
}

.pushes tr > td {
  border: 1px dotted #bbd;
  padding: 4px;
  width: 10%;
  height: 30px;
  margin: 0;
  font-size: 13px;
}

.pushes td.date {
  border-right: 0 !important;
}

.pushes td.empty {
  border: 0 !important;
}

.pushes tr.signoff td,
.pushes tr.accepted td {
  text-align: center;
}

.legend {
  display: inline;
  margin-top: 20px;
  margin-left: 10px;
}

.legend ul {
  list-style-type: none;
  margin: 0;
  padding:0;
}

.legend ul li {
  float: left;
  margin-left: 10px;
}

.legend .box {
  width: 20px;
  height: 10px;
  display: inline-block;
  border: 1px solid black;
}

.slider {
  float: right;
  margin-top: 10px;
  margin-right: 10px;
}

.slider .prev,
.slider .next,
.slider .slide {
  display: inline-block;
}

.slider .slide {
  width: 100px;
  height: 15px;
  background-color: #d59;
  overflow: hidden;
}

.slider .slide .marker {
  width: 0px;
  height: 15px;
  background-color: green;
}

.search {
  float: right;
}

.legend .box.accepted {background-color:#efe;}
.legend .box.refused {background-color:#ff0000;}
.legend .box.signedoff {background-color:#99ff99;}
.legend .box.paccepted {background-color: #dde;}

#pushes tr:not(.date) td.current {
  border: 1px solid #9a9 !important;
  background-color: #efe !important;
  color: black !important;
{% ifequal curcol 1 %}
  background-color: #99ff99 !important;
{% endifequal %}

{% ifequal curcol -1 %}
  background-color: #ff0000 !important;
{% endifequal %}
}

{% if accepted %}
{% ifnotequal accepted.push.id current.push.id %}
#pushes td.push-{{ accepted.push.id }}:not(.date) {
  border: 1px solid #aac !important;
  background-color: #dde !important;
  color: black !important;
}
{% endifnotequal %}
{% endif %}
{% endblock %}

{% block content %}
<div class="nav">
  <a href="{% url signoff.views.dashboard %}?ms={{mstone.code}}">Â« all <i>{{mstone.name}}</i> locales</a>
</div>
<p class="search">Search: <input type="text" size="10" id="search"></p>
<h3>Signoff for {{mstone}} {{locale.code}}</h3>
<form action="" method="post" id="form_accept">
  <input type="hidden" id="id_comment" name="comment" />
  <input type="hidden" id="id_accepted" name="accepted" />
  <input type="hidden" id="id_first_row2" name="first_row" />
</form>
<form action="" method="post" id="form_signoff">
  <input type="hidden" id="id_push" name="push" />
  <input type="hidden" id="id_first_row" name="first_row" />
</form>

<table id="pushes" class="pushes">
  <tr class="date"></tr>
  <tr class="time"></tr>
  <tr class="revision"></tr>
  <tr class="user"></tr>
  <tr class="build"></tr>
  <tr class="compare"></tr>
  <tr class="signoff"></tr>
  <tr class="accepted"></tr>
</table>
<fieldset class="legend">
  <legend>Legend</legend>
  <ul>
  	<li><div class="box accepted"></div> - accepted</li>
  	<li><div class="box paccepted"></div> - previously accepted</li>
  	<li><div class="box refused"></div> - refused</li>
  	<li><div class="box signedoff"></div> - signed off</li>
  </ul>
</fieldset>
<div class="slider">
  <button class="prev">prev</button>
  <div class="slide">
    <div class="marker"></div>
  </div>
  <button class="next">next</button>
</div>
{% for id, note in notes.items %}
  <fieldset class="note {{ id }}">
    <legend>{{ id }}!</legend>
  {{ note|safe }}
  </fieldset>
{% endfor %}

{% endblock %}